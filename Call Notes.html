<!DOCTYPE html>
<html>
<head>
<style>
input{
  padding: 5px;
}

.slim{
  padding: 1px;
}

.collapsible {
  background-color: #f1f1f1;
  cursor: pointer;
  border: none;
  text-align: Right;
  outline: none;
}

.active, .collapsible:hover, .collapsible:focus {
  background-color: #d1d1d1;
}

.content {
  display: none;
  overflow: hidden;
  background-color: #f5f5f5;
}
</style>
</head>
<body>

<!--
/***********************
*FORM - Top row buttons
************************/
-->

<button onclick="moveToNextCall()"> _‚è≠ üìû_ </button>
  <button onclick="extraTicket()">‚ûïüé´(-)</button>
  <button onclick="copyTicket()">‚ûïüé´(üìÑ)</button><br>

<!--
/******************
*FORM - Basic info
*******************/
-->

<label for="Ticket">Ticket:</label>
  <input type="text" id="Ticket" name="Ticket" size="40"><br>
<label for="UserID">User ID:</label>
  <input type="text" id="UserID" name="UserID"><button tabindex="1" onclick="ToCAPS()">ABC </button> <button tabindex="1" onclick="ToLower()">abc</button><button type="button" class="collapsible" style="width: 100px;" id="phonebutton">More Details</button>
<div class="content" id="phonearea">
  <label for="FullName">Name:</label>
  <input type="text" id="FullName" name="FullName"><br>
  <label for="phone">Phone:</label><br>
  <textarea id="phone" name="phone" rows="2" cols="30"></textarea>
</div><br>
<label for="App">App:</label>
  <input type="text" id="App" name="App">
  <input tabindex="1" type="text" id="KBID" name="KBID">
  <button tabindex="1" 	onclick="KBCIURL()">üîçCI</button><br>

<!--
/************************
*FORM - Call Description
*************************/
-->

<p></p>
<label for="this_call">Call Notes for </label> <select name="TicketType" id= "TicketType">
  <option value="___ > ">___ > </option>
  <option value="issue > ">issue > </option>
  <option value="question > ">question > </option>
  <option value="task > ">task > </option>
</select>
<!--
<button type="button" class="collapsible" style="width: 250px;" id="more_notes_button">More Notes</button>
<div class="content" id="more_notes">
  <label for="temp_info">Temp:</label>
    <input type="text" id="temp_info" name="temp_info"><br>
  <label for="next_ticket_notes">Next Tickets Notes:</label><br>
    <textarea id="next_ticket_notes" name="next_ticket_notes" rows="4" cols="60"></textarea><br>
  This Ticket's Notes:
</div>
-->
<br>
<textarea id="this_call" name="this_call" rows="10" cols="60"></textarea><br>

<!--
/************************
*FORM - Location info
*************************/
-->

<input list="RemoteOrNots" name="RemoteOrNot" id="RemoteOrNot" size="7">
<datalist id="RemoteOrNots">
  <option value="Onsite">
  <option value="Remote">
</datalist>
<input list="facilities" name="facility" id="facility" size="13">
<input type="text" id="LocationDetails" name="LocationDetails" size="25">
<br>

<!--
/************************
*FORM - Dynamic Form
*************************/
-->

<label for="steps">Troubleshooting(<input class="slim" list="macros_02" name="macro_02" id="facility" size="7" >):</label><button type="button" class="collapsible" style="width: 250px;" id="macro_02_button">More Questions</button>
<div class="content" id="macro_02_questions">
  <label for="macro_02_a01" id="macro_02_q01">Is this inpatient or outpatient? = </label>
  <input type="text" id="macro_02_a01" name="macro_02_a01"><br>
  <label for="macro_02_a02" id="macro_02_q02">Job Title/Role = </label>
  <input type="text" id="macro_02_a02" name="macro_02_a02"><br>
  <label for="macro_02_a03" id="macro_02_q03">Department = </label>
  <input type="text" id="macro_02_a03" name="macro_02_a03"><br>
  <label for="macro_02_a04" id="macro_02_q04">Epic Template used = </label>
  <input list="epic_templates" type="text" id="macro_02_a04" name="macro_02_a04"><br>
  <label for="macro_02_a05" id="macro_02_q05">Did the user have access before? (if applicable) = </label>
  <input type="text" id="macro_02_a05" name="macro_02_a05"><br>
  <label for="macro_02_a06" id="macro_02_q06">Is this occurring for several patients in Epic? = </label>
  <input type="text" id="macro_02_a06" name="macro_02_a06"><br>
  <label for="macro_02_a07" id="macro_02_q07">Is this issue affecting several co-workers? = </label>
  <input type="text" id="macro_02_a07" name="macro_02_a07"><br>
  <label for="macro_02_a08" id="macro_02_q08">Have you restarted user's VDI session? (If applicable) = </label>
  <input type="text" id="macro_02_a08" name="macro_02_a08"><br>
  <label for="macro_02_a09" id="macro_02_q09">Screenshot of error / issue attached? = </label>
  <input type="text" id="macro_02_a09" name="macro_02_a09"><br>
</div><br>

<!--
/************************
*FORM - Troubleshooting Space
*************************/
-->

<textarea id="steps" name="steps" rows="8" cols="60"></textarea><br>

<!--
/************************
*FORM - PC info
*************************/
-->

<label for="PCinfo">PC:</label>
<textarea id="PCinfo" name="PCinfo" rows="2" cols="30"></textarea><button onclick="CleanBomgar()">Bomgar</button><button onclick="PCUnableToObtain()">Unknown</button><br>

<!--
/************************
*FORM - Print-out area
*************************/
-->

<label for="ProcText">For Proc:</label>
<button onclick="CompressCall()">Ticket</button><button onclick="FollowupCall()">Call</button><button onclick="EpicCall()">Epic</button><br>
<textarea id="ProcText" name="ProcText" rows="3" cols="60"></textarea><br>

<!--
/************************
*FORM - Escalation
*************************/
-->

<label for="Escalations">Escalation?</label>
<select name="Escalations" id= "Escalations">
  <option value="___">___</option>
  <option value="Standard">Standard</option>
  <option value="Epic">Epic</option>
  <option value="PeopleSoft">PeopleSoft</option>
  <option value="Possible Outage">Possible Outage</option>
</select>
<span style="background-color: #f3f3f3;"><input type="checkbox" id="APCEsc" name="APCEsc"><label for="APCEsc">Affecting Patient Care?</label><span>
<button onclick="makeEscSubjLine()">Generate</button>
<br>

<!--
/*******************************
*FORM - Macro for Repeated Calls
********************************/
-->

<button onclick="ApplyMacro01()">Apply</button><button type="button" class="collapsible" style="width: 400px;">Macro</button>
<div class="content">
  <label for="macro_01_this_call">Call Notes </label><br>
  <textarea id="macro_01_this_call" name="macro_01_this_call" rows="10" cols="60"></textarea><br>

  <label for="macro_01_steps">Troubleshooting:</label><br>
  <textarea id="macro_01_steps" name="macro_01_steps" rows="8" cols="60"></textarea><br>
</div>

<!--
/************************
*FORM - Call Logs
*************************/
-->

<p>---</p>


<p><label for="call_log">Call Logs</label></p>
<textarea id="call_log" name="call_log" rows="40" cols="60"></textarea><br>




<script>

/******************
Intialization
******************/

var coll = document.getElementsByClassName("collapsible");
var i;

for (i = 0; i < coll.length; i++) {
  coll[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var content = this.nextElementSibling;
    if (content.style.display === "block") {
      content.style.display = "none";
    } else {
      content.style.display = "block";
    }
  });
}

let DynamicFormItemType = {
  Text : function() {
    return "type=\"text\"";
  },
  List : function(listName) {
    return "list=\"" + listName + "\" type=\"text\"";
  }
}

class DynamicFormItem{
  constructor(id, type, label) {
    this.id = id;
    this.type = type;
    this.label = label;
    this.value = "";
  }
  
  toHTML() {
    let html_code = "";
    html_code = html_code
      .concat("<label for=\"" + this.id + "\" id=\"" + this.id + "_label\">" + this.label + "</label>")
      .concat("<input " + this.type + " id=\"" + this.id + "\" name=\"" + this.id + "\"><br>");
    return html_code;
  }

}


/******************
Button Methods
******************/

function EpicCall() {
  let userID = "";
  let ticketID = "";
  let AppID = "";
  let KBID = "";
  let TicketType = "";
  let callNotes = "";
  let steps = "";
  let PCname = "";
  let RemoteOrNot = "";
  let facility = "";
  let LocationDetails = "";
  let macro_02_a01 = "";
  let macro_02_a02 = "";
  let macro_02_a03 = "";
  let macro_02_a04 = "";
  let macro_02_a05 = "";
  let macro_02_a06 = "";
  let macro_02_a07 = "";
  let macro_02_a08 = "";
  let macro_02_a09 = "";
  
  let compNotes = "";
  
  userID          = ValueCalled("UserID");
  ticketID        = ValueCalled("Ticket");
  AppID           = ValueCalled("App");
  KBID            = ValueCalled("KBID");
  TicketType      = ValueCalled("TicketType");
  callNotes       = ValueCalled("this_call");
  steps           = ValueCalled("steps");
  PCname          = ValueCalled("PCinfo");
  RemoteOrNot     = ValueCalled("RemoteOrNot");
  facility        = ValueCalled("facility");
  LocationDetails = ValueCalled("LocationDetails");
  macro_02_a01    = ValueCalled("macro_02_a01");
  macro_02_a02    = ValueCalled("macro_02_a02");
  macro_02_a03    = ValueCalled("macro_02_a03");
  macro_02_a04    = ValueCalled("macro_02_a04");
  macro_02_a05    = ValueCalled("macro_02_a05");
  macro_02_a06    = ValueCalled("macro_02_a06");
  macro_02_a07    = ValueCalled("macro_02_a07");
  macro_02_a08    = ValueCalled("macro_02_a08");
  macro_02_a09    = ValueCalled("macro_02_a09");
  
  compNotes = compNotes.concat("Issue / Request Description = ")
    .concat("\n" + AppID)
    .concat(" " + TicketType)
    .concat(callNotes)
    .concat("\n\nIs this inpatient or outpatient? = " + macro_02_a01)
    .concat("\n\nDid the user have access before? (if applicable) = " + macro_02_a05)
    .concat("\nIs this occurring for several patients in Epic? = " + macro_02_a06)
    .concat("\nIs this issue affecting several co-workers? = " + macro_02_a07)
    .concat("\nHave you restarted user's VDI session? (If applicable) = " + macro_02_a08)
    .concat("\nScreenshot of error / issue attached? = " + macro_02_a09)
    .concat("\n\nUsername = " + userID)
    .concat("\nJob Title/Role = " + macro_02_a02)
    .concat("\nDepartment = " + macro_02_a03)
    .concat("\nEpic Template used = " + macro_02_a04)
    .concat("\n\nPC Name = " + PCname)
    .concat("\n\n*** Troubleshooting steps ***\n" + steps)
    .concat("\n\n\nSending to Tier 2 per KB:")
    .concat("\n" + getEscSubjLine());

ObjCalled("ProcText").value = compNotes;
}

function FollowupCall() {
  let userID = "";
  let ticketID = "";
  let FullName = "";
  let phone = "";
  
  let compNotes = "";
  
  userID     = ValueCalled("UserID");
  ticketID   = ValueCalled("Ticket");
  FullName   = ValueCalled("FullName");
  phone      = ValueCalled("phone");
  
  if (FullName == "") FullName = "___";
  
  compNotes = compNotes
    .concat("Caller = " + FullName + " (" + userID + ")")
    .concat("\nCallback = " + phone)
    .concat("\nFor = " + ticketID);

  ObjCalled("ProcText").value = compNotes;
}

function ToCAPS() {
  ObjCalled("UserID").value = ValueCalled("UserID").toUpperCase();
  ObjCalled("UserID").focus();
}

function ToLower() {
  ObjCalled("UserID").value = ValueCalled("UserID").toLowerCase();
  ObjCalled("UserID").focus();
}

function ApplyMacro01() {
  ObjCalled("this_call").value = ValueCalled("this_call").concat(ValueCalled("macro_01_this_call"));
  ObjCalled("steps").value = ValueCalled("steps").concat(ValueCalled("macro_01_steps"));
}

function PCUnableToObtain() {
  ObjCalled("PCinfo").value = ValueCalled("PCinfo").concat("(unable to obtain)");
}

function KBCIURL() {
  let KBID = ValueCalled("KBID");
  let KBCIsite = "http://esdwiki.nychhc.org/index.php?title=Special:Search&search=" + KBID + "#ServiceNow_CI";
  window.open(KBCIsite);
}

function CleanBomgar() {
  let fullStats = "";
  let PCname = "";
  let PCname_start = "Computer Name:       ";
  let PCname_end = "Operating System:    ";
  let lastReboot = "";
  let lastReboot_start = "Uptime:              ";
  let lastReboot_end = "Required Skills:     ";
  let oldStep = "";
  
  fullStats = ValueCalled("PCinfo");
  oldStep   = ValueCalled("steps");
  
  PCname = StringBetween(fullStats, PCname_start, PCname_end, -1);
  lastReboot = StringBetween(fullStats, lastReboot_start, lastReboot_end, -1);
  
  if(PCname !== "")
  {
    ObjCalled("PCinfo").value = PCname;
    ObjCalled("steps").value = oldStep.concat("\nLast Reboot = " + lastReboot);
  }
}

function CompressCall() {
  let userID = "";
  let ticketID = "";
  let AppID = "";
  let KBID = "";
  let TicketType = "";
  let callNotes = "";
  let steps = "";
  let PCname = "";
  let RemoteOrNot = "";
  let facility = "";
  let LocationDetails = "";
  
  let compNotes = "";
  
  userID          = ValueCalled("UserID");
  ticketID        = ValueCalled("Ticket");
  AppID           = ValueCalled("App");
  KBID            = ValueCalled("KBID");
  TicketType      = ValueCalled("TicketType");
  callNotes       = ValueCalled("this_call");
  steps           = ValueCalled("steps");
  PCname          = ValueCalled("PCinfo");
  RemoteOrNot     = ValueCalled("RemoteOrNot");
  facility        = ValueCalled("facility");
  LocationDetails = ValueCalled("LocationDetails");
    
  compNotes = compNotes.concat("Issue Description (Including Error Message) = ")
    .concat("\n" + AppID)
    .concat(" " + TicketType)
    .concat(callNotes)
    .concat("\n\nESD Troubleshooting = \n" + steps)
    .concat("\n\nPC Name = " + PCname)
    .concat("\nUsername = " + userID)
    .concat("\nKB ID = " + KBID)
    .concat("\n\nLocation = " + RemoteOrNot + " / " + facility + " / " + LocationDetails)
    .concat("\n\n<MID_DOC>")
    .concat("\n> " + ticketID);

  ObjCalled("ProcText").value = compNotes;  
}

function copyTicket() {
  Uncollapse("phonebutton", "phonearea");
  logCall();
  ObjCalled("Ticket").value = "";
}

function extraTicket() {
  let savedData = holdInMap([
    "UserID",
    "FullName",
    "phone",
    "PCinfo",
    "RemoteOrNot",
    "facility",
    "LocationDetails"
  ]);
  
  moveToNextCall();
  Uncollapse("phonebutton", "phonearea");
  
  loadHeldValues(savedData);
}

function moveToNextCall() {
  logCall();
  ClearFields();
}
  
function logCall() {
  let logaddition = "";
  let currentlog = "";
  let newlog = "";
  
  CompressCall();
  
  logaddition = ValueCalled("ProcText");
  currentlog  = ValueCalled("call_log");
  
  newlog = newlog.concat(logaddition);
  newlog = newlog.concat("\n\n---\n\n");
  newlog = newlog.concat(currentlog);
  
  ObjCalled("call_log").value = newlog;
}

function makeEscSubjLine() {
  ObjCalled("ProcText").value =  getEscSubjLine();
}

function getEscSubjLine() {
  let emailsubj = "";
  let emailsubjp1 = "";
  let emailsubjp2 = "___";
  let emailsubjp3 = "___";
  let emailsubjp4 = "";
  let esctype = "";
  let esctick = "";
  
  esctype = ValueCalled("Escalations");
  esctick = ValueCalled("Ticket");

  switch (esctype){
    case "___":
      emailsubjp1 = "Escalation";
      break;
    case "Standard":
      emailsubjp1 = "Escalation";
      break;
    case "Epic":
      emailsubjp1 = "Epic";
      break;
    case "PeopleSoft":
      emailsubjp1 = "PeopleSoft";
      break;
    case "Possible Outage":
      emailsubjp1 = "Possible Outage";
      break;
    default:
      emailsubjp1 = "Unknown";
  }
  
  if (esctick !== "") emailsubjp2 = esctick;
  
  emailsubjp3 = ValueCalled("facility");
  if (emailsubjp3 == "") emailsubjp3 = "___";
  if (ValueCalled("RemoteOrNot") == "Remote") emailsubjp3 = "Remote / " + emailsubjp3;
  
  if (ObjCalled("APCEsc").checked) emailsubjp4 = " **Affecting Patient Care**";
  
  emailsubj = emailsubj.concat(emailsubjp1)
    .concat(" - Ticket# ")
    .concat(emailsubjp2)
    .concat(" (")
    .concat(emailsubjp3)
    .concat(")")
    .concat(emailsubjp4);
  return emailsubj;
}


/******************
* Utility Methods
*******************/

function ObjCalled(inputID){
  return document.getElementById(inputID);
}

function ValueCalled(inputID){
  return ObjCalled(inputID).value;
}

function StringBetween(OriginalString, StartString, EndString, OffsetEnd){
  return OriginalString.slice((OriginalString.indexOf(StartString) + StartString.length), (OriginalString.indexOf(EndString) + OffsetEnd));
}

window.addEventListener('beforeunload', (event) => {
  event.returnValue = `Are you sure you want to leave?`;
});

function ClearFields(){
  ObjCalled("UserID").value = "";
  ObjCalled("Ticket").value = "";
  ObjCalled("FullName").value = "";
  ObjCalled("phone").value = "";
  Collapse ("macro_02_button", "macro_02_questions");
  Collapse ("phonebutton", "phonearea");
  ObjCalled("App").value = "";
  ObjCalled("KBID").value = "";
  ObjCalled("TicketType").value = "___ > ";
  ObjCalled("this_call").value = "";
  ObjCalled("RemoteOrNot").value = "";
  ObjCalled("facility").value = "";
  ObjCalled("LocationDetails").value = "";
  ObjCalled("steps").value = "";
  ObjCalled("PCinfo").value = "";
  ObjCalled("ProcText").value = "";
  ObjCalled("Escalations").value = "___";
  ObjCalled("APCEsc").checked = false;
  ClearMacroQuestions();
}

function ClearMacroQuestions(){
  let id = "";
  for (i = 1; i <= 9; i++) {
    id = "macro_02_a0";
    id = id.concat("" + i);
    ObjCalled(id).value = "";
  }
}

function Collapse (buttonlabel, arealabel) {
  if (ObjCalled(arealabel).style.display === "block") {
    ObjCalled(arealabel).style.display = "none";
    ObjCalled(buttonlabel).classList.toggle("active");
  }
}

function Uncollapse (buttonlabel, arealabel) {
  if (ObjCalled(arealabel).style.display != "block") {
    ObjCalled(arealabel).style.display = "block";
    ObjCalled(buttonlabel).classList.toggle("active");
  }
}

///*
function holdInMap(arrayOfIDs) {
  let savedOnHold = new Map();
  
  arrayOfIDs.forEach((value, index, array) => {
    savedOnHold.set(value, ValueCalled(value));
  });
  
  return savedOnHold;
}
//*/


function loadHeldValues(savedOnHold){
  savedOnHold.forEach((value, key) => {
    ObjCalled(key).value = value;
  });
}


</script>

<!--
/************************
*DATA - LISTS
*************************/
-->


<!--
/************************
*LIST: Epic Templates
*************************/
-->

<datalist id="epic_templates">
  <option value="Inpatient - ClinDoc [100017]">
  <option value="Ambulatory [100001]">
  <option value="---">
  <option value="Professional Billing [100026]">
  <option value="Hospital Billing [100015]">
  <option value="Inpatient - Orders [100018]">
  <option value="---">
  <option value="Anesthesia [100002]">
  <option value="ASAP [100003]">
  <option value="Cadence [100007]">
  <option value="Grand Central [100000]">
  <option value="HIM [100012]">
  <option value="OPTIME [100022]">
  <option value="Radiant [100027]">
  <option value="Research [100030]">
  <option value="Stork [100033]">
</datalist>

<!--
/************************
*LIST: Dynamic Form Names
*************************/
-->

<datalist id="macros_02">
  <option value="___">
  <option value="Epic">
</datalist>

<!--
/************************
*LIST: Facilities
*************************/
-->

<datalist id="facilities">
  <option value="BELLEVUE">
  <option value="CENTRAL OFFICE">
  <option value="COLER">
  <option value="CONEY">
  <option value="CHS">
  <option value="CUMBERLAND">
  <option value="ELMHURST">
  <option value="GOUVERNEUR">
  <option value="HARLEM">
  <option value="HJC">
  <option value="JACOBI">
  <option value="KINGS">
  <option value="LINCOLN">
  <option value="MCKINNEY">
  <option value="METROPOLITAN">
  <option value="NCB">
  <option value="QUEENS">
  <option value="SEAVIEW">
  <option value="WOODHULL">
</datalist>

</body>
</html>
