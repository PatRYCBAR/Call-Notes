<!DOCTYPE html>
<html>
<head>
<style>
input{
  padding: 5px;
}

.collapsible {
  background-color: #f1f1f1;
  cursor: pointer;
  width: 425px;
  border: none;
  text-align: Right;
  outline: none;
}

.active, .collapsible:hover {
  background-color: #d1d1d1;
}

.content {
  display: none;
  overflow: hidden;
  background-color: #f5f5f5;
}
</style>
</head>
<body>

<button onclick="moveToNextCall()">Next Call</button> <button onclick="extraTicket()">Extra Ticket</button><br>

<label for="Ticket">Ticket:</label>
  <input type="text" id="Ticket" name="Ticket" size="40"><br>
<label for="UserID">User ID:</label>
  <input type="text" id="UserID" name="UserID"><br>
<label for="App">App:</label>
  <input type="text" id="App" name="App">
  <input tabindex="1" type="text" id="KBID" name="KBID">
  <button tabindex="1" 	onclick="KBCIURL()">CI</button><br>

<p><label for="this_call">Call Notes </label> <select name="TicketType" id= "TicketType">
  <option value="___ > ">___ > </option>
  <option value="issue > ">issue > </option>
  <option value="question > ">question > </option>
  <option value="task > ">task > </option>
</select></p>
<textarea id="this_call" name="this_call" rows="10" cols="60"></textarea><br>

<label for="steps">Troubleshooting:</label><br>
<textarea id="steps" name="steps" rows="8" cols="60"></textarea><br>

<label for="PCinfo">PC:</label>
<textarea id="PCinfo" name="PCinfo" rows="2" cols="30"></textarea><button onclick="CleanBomgar()">Bomgar</button><button onclick="PCUnableToObtain()">Unknown</button><br>


<label for="ProcText">For Proc:</label>
<button onclick="CompressCall()">Compress</button><br>
<textarea id="ProcText" name="ProcText" rows="3" cols="60"></textarea><br>


<label for="Escalations">Escalation?</label>
<select name="Escalations" id= "Escalations">
  <option value="___">___</option>
  <option value="Standard">Standard</option>
  <option value="Epic">Epic</option>
  <option value="Possible Outage">Possible Outage</option>
  <option value="Affecting Patient Care">Affecting Patient Care</option>
</select>
<button onclick="makeEscSubjLine()">Generate</button>
<br>

<button onclick="ApplyMacro01()">Apply</button><button type="button" class="collapsible">Macro</button>
<div class="content">
<p><label for="macro_01_this_call">Call Notes </label><br>
<textarea id="macro_01_this_call" name="macro_01_this_call" rows="10" cols="60"></textarea><br>

<label for="macro_01_steps">Troubleshooting:</label><br>
<textarea id="macro_01_steps" name="macro_01_steps" rows="8" cols="60"></textarea><br>
</div>

<p>---</p>


<p><label for="call_log">Call Logs</label></p>
<textarea id="call_log" name="call_log" rows="40" cols="60"></textarea><br>




<script>

/******************
Intialization
******************/

var coll = document.getElementsByClassName("collapsible");
var i;

for (i = 0; i < coll.length; i++) {
  coll[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var content = this.nextElementSibling;
    if (content.style.display === "block") {
      content.style.display = "none";
    } else {
      content.style.display = "block";
    }
  });
}

/******************
Utility Methods
******************/

function ObjCalled(inputID){
  return document.getElementById(inputID);
}

function ValueCalled(inputID){
  return ObjCalled(inputID).value;
}

function StringBetween(OriginalString, StartString, EndString, OffsetEnd){
  return OriginalString.slice((OriginalString.indexOf(StartString) + StartString.length), (OriginalString.indexOf(EndString) + OffsetEnd));
}

window.addEventListener('beforeunload', (event) => {
  event.returnValue = `Are you sure you want to leave?`;
});

function ClearFields(){
    ObjCalled("UserID").value = "";
    ObjCalled("Ticket").value = "";
    ObjCalled("App").value = "";
    ObjCalled("KBID").value = "";
    ObjCalled("TicketType").value = "___ > ";
    ObjCalled("this_call").value = "";
    ObjCalled("steps").value = "";
    ObjCalled("PCinfo").value = "";
    ObjCalled("ProcText").value = "";
    ObjCalled("Escalations").value = "___";
}

/******************
Button Methods
******************/

function ApplyMacro01() {
  ObjCalled("this_call").value = ValueCalled("this_call").concat(ValueCalled("macro_01_this_call"));
  ObjCalled("steps").value = ValueCalled("steps").concat(ValueCalled("macro_01_steps"));
}

function PCUnableToObtain() {
  ObjCalled("PCinfo").value = ValueCalled("PCinfo").concat("(unable to obtain)");
}

function KBCIURL() {
  let KBID = ValueCalled("KBID");
  let KBCIsite = "http://esdwiki.nychhc.org/index.php?title=Special:Search&search=" + KBID + "#ServiceNow_CI";
  window.open(KBCIsite);
}

function CleanBomgar() {
  let fullStats = "";
  let PCname = "";
  let PCname_start = "Computer Name:       ";
  let PCname_end = "Operating System:    ";
  let lastReboot = "";
  let oldStep = "";
  let newSteps = "";
  
  fullStats = ValueCalled("PCinfo");
  oldStep   = ValueCalled("steps");
  
  PCname = StringBetween(fullStats, PCname_start, PCname_end, -1);
  
  if(PCname !== "") ObjCalled("PCinfo").value = PCname;
}

function CompressCall() {
  let compressionFact = "";
  let userID = "";
  let ticketID = "";
  let AppID = "";
  let KBID = "";
  let TicketType = "";
  let callNotes = "";
  let steps = "";
  let PCname = "";
  
  let compNotes = "";
  
  userID     = ValueCalled("UserID");
  ticketID   = ValueCalled("Ticket");
  AppID      = ValueCalled("App");
  KBID       = ValueCalled("KBID");
  TicketType = ValueCalled("TicketType");
  callNotes  = ValueCalled("this_call");
  steps      = ValueCalled("steps");
  PCname     = ValueCalled("PCinfo");
  
  compressionFact = compressionFact.concat(userID)
    .concat(ticketID)
    .concat(AppID)
    .concat(KBID)
    .concat(steps)
    .concat(PCname);
    
  compNotes = compNotes.concat("Issue Description (Including Error Message) = ")
    .concat("\n" + AppID)
    .concat(" " + TicketType)
    .concat(callNotes)
    .concat("\n\nESD Troubleshooting = \n" + steps)
    .concat("\n\nPC Name = " + PCname)
    .concat("\nUsername = " + userID)
    .concat("\nKB ID = " + KBID)
    .concat("\n\n<MID_DOC>")
    .concat("\n> " + ticketID);

  ObjCalled("ProcText").value = compNotes;  
}

function extraTicket() {
  let UserID = ValueCalled("UserID");
  moveToNextCall();
  ObjCalled("UserID").value = UserID;
}

function moveToNextCall() {
  let logaddition = "";
  let currentlog = "";
  let newlog = "";
  
  CompressCall();
  
  logaddition = ValueCalled("ProcText");
  currentlog  = ValueCalled("call_log");
  
  newlog = newlog.concat(logaddition);
  newlog = newlog.concat("\n\n---\n\n");
  newlog = newlog.concat(currentlog);
  
  // ObjCalled("this_call").value = "";
  ObjCalled("call_log").value = newlog;
  ClearFields();
}

function makeEscSubjLine() {
  let emailsubj = "";
  let emailsubjp1 = "";
  let emailsubjp2 = "___";
  let emailsubjp3 = "___";
  let emailsubjp4 = "";
  let esctype = "";
  let esctick = "";
  
  esctype = ValueCalled("Escalations");
  esctick = ValueCalled("Ticket");

  switch (esctype){
    case "___":
      emailsubjp1 = "Escalation";
      break;
    case "Standard":
      emailsubjp1 = "Escalation";
      break;
    case "Epic":
      emailsubjp1 = "Epic";
      break;
    case "Possible Outage":
      emailsubjp1 = "Possible Outage";
      break;
    case "Affecting Patient Care":
      emailsubjp1 = "___.Escalation";
      break;
    default:
      emailsubjp1 = "Unknown";
  }
  
  if (esctick !== "") emailsubjp2 = esctick;
  
  if (esctype == "Affecting Patient Care") emailsubjp4 = " **Affecting Patient Care**";
  
  emailsubj = emailsubj.concat(emailsubjp1)
    .concat(" - Ticket# ")
    .concat(emailsubjp2)
    .concat(" (")
    .concat(emailsubjp3)
    .concat(")")
    .concat(emailsubjp4);
  ObjCalled("ProcText").value =  emailsubj;
}
</script>


</body>
</html>
